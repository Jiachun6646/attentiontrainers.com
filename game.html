<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>音乐模仿游戏 - Attention Trainers</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Arial', sans-serif;
        }
        
        body {
            background-color: white;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            height: 100vh;
            width: 100vw;
            overflow: hidden;
        }
        
        #game-container {
            width: 100%;
            max-width: 800px;
            height: 100%;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            padding: 20px;
        }
        
        #header {
            text-align: center;
            padding: 10px;
        }
        
        .game-title {
            font-size: 24px;
            font-weight: bold;
            margin-bottom: 10px;
            color: #333;
        }
        
        #score-display {
            font-size: 20px;
            color: #555;
            margin-bottom: 5px;
        }
        
        #level-display {
            font-size: 18px;
            color: #666;
        }
        
        #status-area {
            text-align: center;
            font-size: 20px;
            margin: 20px 0;
            min-height: 30px;
            color: #333;
        }
        
        #progress-bar-container {
            width: 100%;
            height: 20px;
            background-color: #eee;
            border-radius: 10px;
            margin: 10px 0;
            overflow: hidden;
        }
        
        #progress-bar {
            height: 100%;
            width: 0;
            background-color: #4CAF50;
            transition: width 0.1s;
        }
        
        #controls {
            display: flex;
            justify-content: center;
            gap: 10px;
            margin-bottom: 20px;
        }
        
        button {
            padding: 10px 20px;
            font-size: 16px;
            background-color: #4CAF50;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            transition: background-color 0.3s;
        }
        
        button:hover {
            background-color: #45a049;
        }
        
        button:disabled {
            background-color: #cccccc;
            cursor: not-allowed;
        }
        
        #piano-container {
            display: flex;
            justify-content: center;
            width: 100%;
            margin-top: auto;
            margin-bottom: 20px;
            height: 150px;
        }
        
        #piano {
            display: flex;
            justify-content: center;
            height: 100%;
            width: 100%;
            max-width: 700px;
            position: relative;
        }
        
        .white-key {
            width: calc(100% / 7);
            height: 100%;
            background-color: white;
            border: 1px solid #ccc;
            border-radius: 0 0 5px 5px;
            position: relative;
            z-index: 1;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
        }
        
        .black-key {
            width: calc((100% / 7) * 0.65);
            height: 65%;
            background-color: #333;
            position: absolute;
            z-index: 2;
            border-radius: 0 0 3px 3px;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.3);
        }
        
        .black-key.C♯ {
            left: calc((100% / 7) * 0.68);
        }
        
        .black-key.D♯ {
            left: calc((100% / 7) * 1.68);
        }
        
        .black-key.F♯ {
            left: calc((100% / 7) * 3.68);
        }
        
        .black-key.G♯ {
            left: calc((100% / 7) * 4.68);
        }
        
        .black-key.A♯ {
            left: calc((100% / 7) * 5.68);
        }
        
        .key-active {
            background-color: #e0f7fa;
            box-shadow: 0 0 10px #4fc3f7;
        }
        
        .black-key.key-active {
            background-color: #616161;
            box-shadow: 0 0 10px #9e9e9e;
        }
        
        .key-label {
            position: absolute;
            bottom: 10px;
            width: 100%;
            text-align: center;
            font-size: 14px;
            color: #333;
            pointer-events: none;
        }
        
        .black-key .key-label {
            color: white;
        }
        
        #feedback {
            text-align: center;
            font-size: 24px;
            font-weight: bold;
            min-height: 30px;
            margin: 10px 0;
        }
        
        .feedback-perfect {
            color: #4CAF50;
        }
        
        .feedback-good {
            color: #2196F3;
        }
        
        .feedback-fair {
            color: #FF9800;
        }
        
        .feedback-poor {
            color: #F44336;
        }
        
        @media (max-width: 600px) {
            .game-title {
                font-size: 20px;
            }
            
            #status-area {
                font-size: 16px;
            }
            
            button {
                padding: 8px 16px;
                font-size: 14px;
            }
            
            #piano-container {
                height: 120px;
            }
            
            .key-label {
                font-size: 12px;
            }
        }
        
        @media (max-height: 500px) {
            #piano-container {
                height: 100px;
            }
            
            #header {
                padding: 5px;
            }
            
            #controls {
                margin-bottom: 10px;
            }
        }
    </style>
</head>
<body>
    <div id="game-container">
        <div id="header">
            <div class="game-title">音乐模仿游戏</div>
            <div id="score-display">得分: 0</div>
            <div id="level-display">级别: 1</div>
        </div>
        
        <div id="status-area">点击"播放"按钮开始游戏</div>
        
        <div id="progress-bar-container">
            <div id="progress-bar"></div>
        </div>
        
        <div id="controls">
            <button id="play-button">播放</button>
            <button id="start-record-button" disabled>开始模仿</button>
            <button id="reset-button">重新开始</button>
        </div>
        
        <div id="feedback"></div>
        
        <div id="piano-container">
            <div id="piano">
                <div class="white-key" data-note="C"><div class="key-label">C</div></div>
                <div class="white-key" data-note="D"><div class="key-label">D</div></div>
                <div class="white-key" data-note="E"><div class="key-label">E</div></div>
                <div class="white-key" data-note="F"><div class="key-label">F</div></div>
                <div class="white-key" data-note="G"><div class="key-label">G</div></div>
                <div class="white-key" data-note="A"><div class="key-label">A</div></div>
                <div class="white-key" data-note="B"><div class="key-label">B</div></div>
                
                <div class="black-key C♯" data-note="C♯"><div class="key-label">C♯</div></div>
                <div class="black-key D♯" data-note="D♯"><div class="key-label">D♯</div></div>
                <div class="black-key F♯" data-note="F♯"><div class="key-label">F♯</div></div>
                <div class="black-key G♯" data-note="G♯"><div class="key-label">G♯</div></div>
                <div class="black-key A♯" data-note="A♯"><div class="key-label">A♯</div></div>
            </div>
        </div>
    </div>

    <script>
        // 音频上下文创建
        let audioContext;
        try {
            const AudioContext = window.AudioContext || window.webkitAudioContext;
            audioContext = new AudioContext();
        } catch (e) {
            alert('Web Audio API不受支持。请使用现代浏览器。');
        }
        
        // 游戏状态变量
        let isPlaying = false;
        let isRecording = false;
        let currentLevel = 1;
        let totalScore = 0;
        let patternToPlay = [];
        let playerPattern = [];
        let maxLevel = 10;
        
        // 声音设置
        const notes = {
            'C': 261.63,
            'C♯': 277.18,
            'D': 293.66,
            'D♯': 311.13,
            'E': 329.63,
            'F': 349.23,
            'F♯': 369.99,
            'G': 392.00,
            'G♯': 415.30,
            'A': 440.00,
            'A♯': 466.16,
            'B': 493.88
        };
        
        // DOM元素
        const playButton = document.getElementById('play-button');
        const startRecordButton = document.getElementById('start-record-button');
        const resetButton = document.getElementById('reset-button');
        const pianoKeys = document.querySelectorAll('.white-key, .black-key');
        const statusArea = document.getElementById('status-area');
        const scoreDisplay = document.getElementById('score-display');
        const levelDisplay = document.getElementById('level-display');
        const progressBar = document.getElementById('progress-bar');
        const feedbackArea = document.getElementById('feedback');
        
        // 事件监听器
        playButton.addEventListener('click', playPattern);
        startRecordButton.addEventListener('click', startRecording);
        resetButton.addEventListener('click', resetGame);
        
        pianoKeys.forEach(key => {
            key.addEventListener('mousedown', () => playNote(key.dataset.note));
            key.addEventListener('touchstart', (e) => {
                e.preventDefault();
                playNote(key.dataset.note);
            });
            
            // 如果正在录制，记录玩家的输入
            key.addEventListener('mousedown', () => {
                if (isRecording) {
                    recordNote(key.dataset.note);
                }
            });
            key.addEventListener('touchstart', (e) => {
                e.preventDefault();
                if (isRecording) {
                    recordNote(key.dataset.note);
                }
            });
        });
        
        // 功能函数
        function playNote(note, duration = 0.3) {
            if (!audioContext) return;
            
            // 如果音频上下文被挂起，恢复它
            if (audioContext.state === 'suspended') {
                audioContext.resume();
            }
            
            const oscillator = audioContext.createOscillator();
            const gainNode = audioContext.createGain();
            
            oscillator.type = 'sine';
            oscillator.frequency.value = notes[note];
            
            // 音量淡入淡出
            gainNode.gain.setValueAtTime(0, audioContext.currentTime);
            gainNode.gain.linearRampToValueAtTime(0.5, audioContext.currentTime + 0.01);
            gainNode.gain.linearRampToValueAtTime(0, audioContext.currentTime + duration);
            
            oscillator.connect(gainNode);
            gainNode.connect(audioContext.destination);
            
            oscillator.start();
            oscillator.stop(audioContext.currentTime + duration);
            
            // 视觉反馈
            const keyElement = document.querySelector(`[data-note="${note}"]`);
            keyElement.classList.add('key-active');
            setTimeout(() => keyElement.classList.remove('key-active'), duration * 1000);
        }
        
        function generatePattern(level) {
            const pattern = [];
            const minLength = Math.min(3 + level, 12); // 随着级别增加，模式长度增加
            const maxLength = Math.min(5 + level, 15);
            const patternLength = Math.floor(Math.random() * (maxLength - minLength + 1)) + minLength;
            
            const allNotes = Object.keys(notes);
            
            // 生成包含以下特点的模式：
            // 1. 随机音符
            // 2. 随机持续时间（模拟节奏变化）
            for (let i = 0; i < patternLength; i++) {
                const randomNote = allNotes[Math.floor(Math.random() * allNotes.length)];
                const noteDuration = Math.random() < 0.7 ? 0.3 : 0.15; // 70%的音符是标准长度，30%是短促的
                
                pattern.push({
                    note: randomNote,
                    duration: noteDuration
                });
            }
            
            return pattern;
        }
        
        async function playPattern() {
            if (isPlaying || isRecording) return;
            
            // 重置玩家模式
            playerPattern = [];
            isPlaying = true;
            
            // 禁用按钮
            playButton.disabled = true;
            startRecordButton.disabled = true;
            
            // 生成新模式
            patternToPlay = generatePattern(currentLevel);
            
            // 更新状态
            statusArea.textContent = '请听...';
            feedbackArea.textContent = '';
            
            // 播放动画的总时长
            const totalDuration = patternToPlay.reduce((sum, note) => sum + note.duration + 0.1, 0);
            let elapsedTime = 0;
            
            // 播放模式
            for (let i = 0; i < patternToPlay.length; i++) {
                const note = patternToPlay[i];
                
                // 更新进度条
                const progress = (elapsedTime / totalDuration) * 100;
                progressBar.style.width = `${progress}%`;
                
                // 播放音符
                playNote(note.note, note.duration);
                
                // 等待音符持续时间
                await new Promise(resolve => setTimeout(resolve, note.duration * 1000 + 100));
                elapsedTime += note.duration + 0.1;
            }
            
            // 完成播放
            progressBar.style.width = '100%';
            isPlaying = false;
            startRecordButton.disabled = false;
            playButton.disabled = false;
            
            // 更新状态
            statusArea.textContent = '轮到你了！点击"开始模仿"按钮。';
            
            // 延迟重置进度条
            setTimeout(() => {
                progressBar.style.width = '0%';
            }, 500);
        }
        
        function startRecording() {
            if (isRecording || isPlaying) return;
            
            isRecording = true;
            playerPattern = [];
            
            // 禁用按钮
            playButton.disabled = true;
            startRecordButton.disabled = true;
            
            // 更新状态
            statusArea.textContent = '正在录制...点击钢琴键模仿节奏';
            
            // 设置超时，如果玩家没有输入足够的音符
            setTimeout(() => {
                if (isRecording) {
                    finishRecording();
                }
            }, 15000); // 15秒超时
        }
        
        function recordNote(note) {
            if (!isRecording) return;
            
            // 记录玩家点击的音符和时间
            const now = Date.now();
            if (playerPattern.length > 0) {
                const timeSinceLastNote = now - playerPattern[playerPattern.length - 1].timestamp;
                playerPattern[playerPattern.length - 1].gapAfter = timeSinceLastNote / 1000;
            }
            
            playerPattern.push({
                note: note,
                timestamp: now,
                gapAfter: 0
            });
            
            // 如果玩家输入了足够的音符
            if (playerPattern.length >= patternToPlay.length) {
                finishRecording();
            }
        }
        
        function finishRecording() {
            if (!isRecording) return;
            
            isRecording = false;
            
            // 启用按钮
            playButton.disabled = false;
            startRecordButton.disabled = false;
            
            // 计算得分
            const score = calculateScore();
            const scaledScore = Math.round(score * 100);
            
            // 更新总分
            totalScore += scaledScore;
            scoreDisplay.textContent = `得分: ${totalScore}`;
            
            // 显示反馈
            let feedback;
            let feedbackClass;
            
            if (score >= 0.9) {
                feedback = '完美！';
                feedbackClass = 'feedback-perfect';
                // 如果表现优秀，增加级别
                if (currentLevel < maxLevel) {
                    currentLevel++;
                    levelDisplay.textContent = `级别: ${currentLevel}`;
                }
            } else if (score >= 0.7) {
                feedback = '很好！';
                feedbackClass = 'feedback-good';
            } else if (score >= 0.5) {
                feedback = '不错！';
                feedbackClass = 'feedback-fair';
            } else {
                feedback = '再试一次';
                feedbackClass = 'feedback-poor';
            }
            
            feedbackArea.textContent = feedback;
            feedbackArea.className = '';
            feedbackArea.classList.add(feedbackClass);
            
            // 更新状态
            statusArea.textContent = `您的得分: ${scaledScore}。点击"播放"按钮继续。`;
        }
        
        function calculateScore() {
            if (playerPattern.length === 0 || patternToPlay.length === 0) return 0;
            
            let score = 0;
            const maxScore = patternToPlay.length;
            
            // 比较音符匹配度
            for (let i = 0; i < Math.min(playerPattern.length, patternToPlay.length); i++) {
                // 1. 音符匹配检查
                if (playerPattern[i].note === patternToPlay[i].note) {
                    score += 0.7; // 音符匹配占70%分数
                }
                
                // 2. 节奏匹配检查（更复杂，需要比较时间间隔）
                if (i < patternToPlay.length - 1 && i < playerPattern.length - 1) {
                    // 对比下一个音符的时间间隔
                    const expectedGap = patternToPlay[i].duration;
                    const actualGap = playerPattern[i].gapAfter / 1000; // 转换为秒
                    
                    // 计算节奏匹配度（宽容度：±30%）
                    const rhythmAccuracy = Math.max(0, 1 - Math.abs(expectedGap - actualGap) / expectedGap);
                    score += 0.3 * rhythmAccuracy; // 节奏匹配占30%分数
                }
            }
            
            // 如果玩家输入的音符比模式少，或者比模式多，扣分
            const lengthPenalty = Math.abs(playerPattern.length - patternToPlay.length) * 0.2;
            score = Math.max(0, score - lengthPenalty);
            
            // 归一化分数
            return score / maxScore;
        }
        
        function resetGame() {
            // 重置所有游戏变量
            isPlaying = false;
            isRecording = false;
            currentLevel = 1;
            totalScore = 0;
            patternToPlay = [];
            playerPattern = [];
            
            // 更新UI
            scoreDisplay.textContent = `得分: 0`;
            levelDisplay.textContent = `级别: 1`;
            statusArea.textContent = `点击"播放"按钮开始游戏`;
            feedbackArea.textContent = '';
            progressBar.style.width = '0%';
            
            // 启用按钮
            playButton.disabled = false;
            startRecordButton.disabled = true;
        }
        
        // 响应式布局调整
        function handleResize() {
            const container = document.getElementById('game-container');
            const containerWidth = container.offsetWidth;
            const piano = document.getElementById('piano');
            
            // 调整钢琴宽度以适应容器
            if (containerWidth < 500) {
                piano.style.width = '100%';
            } else {
                piano.style.width = '80%';
            }
        }
        
        // 初始化时调整大小
        window.addEventListener('resize', handleResize);
        handleResize();
        
        // 触摸设备的其他事件处理
        document.addEventListener('touchend', function(e) {
            if (e.target.classList.contains('white-key') || e.target.classList.contains('black-key')) {
                e.preventDefault();
            }
        });
        
        // 键盘控制支持
        const keyMap = {
            'a': 'C',
            'w': 'C♯',
            's': 'D',
            'e': 'D♯',
            'd': 'E',
            'f': 'F',
            't': 'F♯',
            'g': 'G',
            'y': 'G♯',
            'h': 'A',
            'u': 'A♯',
            'j': 'B'
        };
        
        document.addEventListener('keydown', function(e) {
            const key = e.key.toLowerCase();
            if (keyMap[key]) {
                playNote(keyMap[key]);
                if (isRecording) {
                    recordNote(keyMap[key]);
                }
            }
        });
        
        // 添加帮助说明
        const helpText = document.createElement('div');
        helpText.style.position = 'absolute';
        helpText.style.bottom = '10px';
        helpText.style.right = '10px';
        helpText.style.fontSize = '12px';
        helpText.style.color = '#999';
        helpText.innerHTML = '键盘控制: A-J (白键) | W,E,T,Y,U (黑键)';
        document.body.appendChild(helpText);
    </script>
</body>
</html>
